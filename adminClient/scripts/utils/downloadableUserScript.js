localStorage.setItem('userScript', "const adminId=\"{{adminId}}\",emojiMapping={floare:\"ðŸŒ¼\",flower:\"ðŸŒ¼\",tree:\"ðŸŒ³\",copac:\"ðŸŒ³\",soare:\"ðŸŒž\",sun:\"ðŸŒž\",caine:\"ðŸ¶\",dog:\"ðŸ¶\",pisica:\"ðŸˆ\",cat:\"ðŸˆ\",ok:\"ðŸ‘\",haha:\"ðŸ˜‚\",umbrela:\"â˜‚ï¸\",umbrella:\"â˜‚ï¸\",ochelari:\"ðŸ‘“\",glasses:\"ðŸ‘“\",inima:\"â¤ï¸\",heart:\"â¤ï¸\",ploaie:\"ðŸ’§\",rain:\"ðŸ’§\",mar:\"ðŸŽ\",apple:\"ðŸŽ\",tort:\"ðŸ°\",cake:\"ðŸ°\",carte:\"ðŸ“–\",book:\"ðŸ“–\"},addMessage=(e,t,s,a=\"https://media.healthyfood.com/wp-content/uploads/2017/03/Why-we-like-cherries--500x753.jpg\")=>{const o=document.querySelector(\".messages-wrapper\"),n=document.createElement(\"div\"),l=JSON.parse(localStorage.getItem(\"chatSettings\")).avatar,i=JSON.parse(localStorage.getItem(\"chatSettings\")).theme;localStorage.setItem(\"lastMessageTimestamp\",s);const c=new Date(s);t!==JSON.parse(localStorage.getItem(\"userData\")).email?n.innerHTML=`\t\t<li class=\"single-message-wrapper\">\t\t\t<div class=\"text-wrapper admin\">\t\t\t\t<img class=\"message-avatar ${l}\" src=\"${a}\" />\t\t\t\t<div class=\"message admin-message ${i}\">\t\t\t\t\t<p>${e}</p>\t\t\t\t\t<label class=\"message-timestamp\">${`${c.getHours()}:${c.getMinutes()}`}</label>\t\t\t\t</div>\t\t\t</div>\t\t</li>\t\t`:n.innerHTML=`\t\t<li class=\"single-message-wrapper\">\t\t\t<div class=\"text-wrapper\">\t\t\t\t<img class=\"message-avatar ${l}\" src=\"${a}\" />\t\t\t\t<div class=\"message ${i}\">\t\t\t\t\t<p>${e}</p>\t\t\t\t\t<label class=\"message-timestamp\">${`${c.getHours()}:${c.getMinutes()}`}</label>\t\t\t\t</div>\t\t\t</div>\t\t</li>\t\t`,o.appendChild(n),document.querySelector(\".chat-wrapper\").classList.add(i),document.querySelector(\".general-close-button\").classList.add(i)},processMessage=()=>{const e=document.querySelector(\"#message-input\").value.split(\" \"),t=e[e.length-1].toLowerCase();Object.keys(emojiMapping).includes(t)?(document.querySelector(\".emoji-suggestion-button\").style.display=\"block\",document.querySelector(\".emoji-suggestion-button\").innerHTML=emojiMapping[t]):document.querySelector(\".emoji-suggestion-button\").style.display=\"none\"},replaceLastWordWithEmoji=()=>{const e=document.querySelector(\"#message-input\").value.split(\" \"),t=e[e.length-1],s=e.lastIndexOf(t);e.splice(s,1,emojiMapping[t.toLowerCase()]),document.querySelector(\"#message-input\").value=e.join(\" \"),document.querySelector(\".emoji-suggestion-button\").style.display=\"none\",document.querySelector(\"#message-input\").focus()},retrieveMessages=(e=9999)=>{const t=JSON.parse(localStorage.getItem(\"userData\")).email;fetch(`http://localhost:8000/chats/${adminId}/${t}?limit=${e}`,{headers:new Headers({Authorization:\"Bearer \"+localStorage.getItem(\"jwt\")})}).then(async t=>{const s=(await t.json()).reverse();if(1!==e)for(const e of s){const t=await fetch(`http://localhost:8000/users/${e.userId}`,{headers:new Headers({Authorization:\"Bearer \"+localStorage.getItem(\"jwt\")})}),s=await t.json();addMessage(e.data,e.userId,e.timestamp,s.avatar_link)}else if(parseInt(localStorage.getItem(\"lastMessageTimestamp\"))!==s[0].timestamp){const e=await fetch(`http://localhost:8000/users/${s[0].userId}`,{headers:new Headers({Authorization:\"Bearer \"+localStorage.getItem(\"jwt\")})}),t=await e.json();addMessage(s[0].data,s[0].userId,s[0].timestamp,t.avatar_link)}}).catch(function(e){console.log(\"Messages could not be retrieved\",e)})};retrieveMessages(),setInterval(()=>retrieveMessages(limit=1),3e3);const sendMessage=()=>{const e=document.querySelector(\"#message-input\").value;document.querySelector(\"#message-input\").value=\"\";const t=JSON.parse(localStorage.getItem(\"userData\")).email;if(e.length>0){const s=Date.now();fetch(`http://localhost:8000/chats/${adminId}/${t}`,{method:\"POST\",body:JSON.stringify({userId:t,data:e,timestamp:s}),headers:new Headers({Authorization:\"Bearer \"+localStorage.getItem(\"jwt\")})}).catch(function(e){console.log(\"Message could not be sent\",e)})}},applyChatSettings=async()=>{const e=document.querySelector(\".start-chat-button\");document.querySelector(\".message-avatar\");const t=document.querySelector(\".chat-wrapper\");document.querySelector(\".message\");const s=await fetch(\"http://localhost:8000/chatSettings\"),a=await s.json();localStorage.setItem(\"chatSettings\",JSON.stringify(a)),t.classList.add(a.position),e.classList.add(a.position)},openChat=async()=>{const e=document.querySelector(\".chat-wrapper\"),t=document.querySelector(\".start-chat-button\");e.classList.remove(\"invisible\"),e.classList.add(\"visible\"),t.classList.remove(\"visible-block\"),t.classList.add(\"invisible\")},closeChat=()=>{const e=document.querySelector(\".chat-wrapper\"),t=document.querySelector(\".start-chat-button\");e.classList.remove(\"visible\"),e.classList.add(\"invisible\"),t.classList.remove(\"invisible\"),t.classList.add(\"visible-block\")};async function login(e){localStorage.setItem(\"jwt\",e);try{const t=atob(e.split(\".\")[1]);localStorage.setItem(\"userData\",t)}catch(e){return void console.log(\"Error decoding JWT\",e)}}const register=async()=>{const e=document.querySelector(\"#email-field\").value,t=document.querySelector(\"#password-field\").value,s=document.querySelector(\"#name-field\").value,a=document.querySelector(\"#avatar-field\").value,o=document.querySelector(\".field-validation-error\");e&&t&&a&&s?(o.classList.remove(\"visible\"),o.classList.add(\"invisible\")):(o.classList.remove(\"invisible\"),o.classList.add(\"visible\")),e&&t&&a&&s&&(fetch(\"http://localhost:8000/users\",{method:\"POST\",body:JSON.stringify({email:e,password:t,name:s,avatar_link:a})}).then(function(e){return e.ok?e.json():Promise.reject(e)}).then(function(e){console.log(\"Registration successful\"),window.location.replace(\"/userClient/login.html\")}).catch(function(e){console.log(\"Registration error\",e)}),document.querySelector(\"#email-field\").value=\"\",document.querySelector(\"#password-field\").value=\"\",document.querySelector(\"#name-field\").value=\"\",document.querySelector(\"#avatar-field\").value=\"\")};window.onload=(async()=>{const e=document.createElement(\"div\");e.innerHTML='<button class=\"general-button start-chat-button visible-block\" type=\"button\" onclick=\"openChat()\"> CHAT </button>    <div class=\"chat-wrapper invisible\">        <ul class=\"messages-wrapper\">        </ul>        <div class=\"message-input-wrapper\">            <input type=\"text\" id=\"message-input\" class=\"general-input\" name=\"message\" placeholder=\"Type a message\"                oninput=\"processMessage()\" />            <button class=\"general-button send-message-button\" type=\"button\" onclick=\"sendMessage()\"> SEND </button>            <button class=\"emoji-suggestion-button\" type=\"button\" onclick=\"replaceLastWordWithEmoji()\">        </div>        <button class=\"general-close-button\" type=\"button\" onclick=\"closeChat()\">X</button>    </div>',document.body.appendChild(e),await applyChatSettings()});");

function exportUserScript() {
    const adminId = JSON.parse(localStorage.getItem('userData')).email;
	var blob = new Blob([localStorage.getItem('userScript').replace('{{adminId}}', adminId)], { type: 'text/plain;charset=utf-8;' });

	var link = document.createElement('a');
	if (link.download !== undefined) {
		var url = URL.createObjectURL(blob);
		link.setAttribute('href', url);
		link.setAttribute('download', 'userScript.js');
		link.style.visibility = 'hidden';
		document.body.appendChild(link);
		link.click();
		document.body.removeChild(link);
	}
}
